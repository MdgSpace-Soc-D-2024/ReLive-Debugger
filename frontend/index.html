<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Web Debugger</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }

        .sidebar {
            width: 280px;
            background-color: #252526;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border-right: 1px solid #3c3c3c;
        }

        .content {
            flex-grow: 1;
            display: grid;
            grid-template-rows: 1fr 250px 200px;
            overflow: hidden;
        }

        h2, h3 {
            color: #ffffff;
            margin: 0 0 15px 0;
            font-weight: 500;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 15px 0;
            border-bottom: 1px solid #3c3c3c;
        }

        button {
            padding: 8px 12px;
            background-color: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        button:hover:not(:disabled) {
            background-color: #1177bb;
        }

        button:disabled {
            background-color: #404040;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .code-area {
            background-color: #1e1e1e;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
            padding: 10px 0;
        }

        .code-line {
            padding: 0 15px 0 50px;
            position: relative;
            white-space: pre;
            min-height: 21px;
        }

        .code-line:hover {
            background-color: #2d2d2d;
        }

        .code-line.active {
            background-color: #264f78;
        }

        .code-line::before {
            content: attr(data-line);
            position: absolute;
            left: 0;
            width: 40px;
            padding-right: 10px;
            color: #858585;
            text-align: right;
        }

        .code-line.breakpoint::after {
            content: "‚óè";
            position: absolute;
            left: 3px;
            color: #d16969;
        }

        .debug-info {
            background-color: #252526;
            border-top: 1px solid #3c3c3c;
            display: grid;
            grid-template-columns: 1fr 1fr;
            overflow: hidden;
        }

        .variables-panel, .stack-panel {
            padding: 15px;
            overflow-y: auto;
            border-right: 1px solid #3c3c3c;
        }

        .variable-item, .stack-frame {
            padding: 5px 10px;
            border-radius: 3px;
            margin: 2px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .variable-item:hover, .stack-frame:hover {
            background-color: #2d2d2d;
        }

        .output-panel {
            background-color: #1e1e1e;
            border-top: 1px solid #3c3c3c;
            padding: 15px;
            overflow-y: auto;
        }

        .output-content {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            margin: 0;
            color: #dcddde;
        }

        input[type="file"] {
            display: none;
        }

        .file-upload-label {
            display: inline-block;
            padding: 8px 12px;
            background-color: #0e639c;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            transition: background-color 0.2s;
        }

        .file-upload-label:hover {
            background-color: #1177bb;
        }

        .breakpoint-input {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        input[type="number"] {
            padding: 6px;
            background-color: #3c3c3c;
            border: 1px solid #525252;
            border-radius: 4px;
            color: white;
            width: 80px;
        }

        .error {
            color: #f48771;
            margin-top: 10px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Relive Debugger</h2>
        
        <div class="control-group">
            <label class="file-upload-label" for="fileInput">
                Load File
            </label>
            <input type="file" id="fileInput" accept=".py" />
            <button id="startButton" onclick="startDebugger()">Start Debugger</button>
        </div>

        <div class="control-group">
            <button id="stepButton" onclick="step()" disabled>Step Into</button>
            <button id="stepOverButton" onclick="stepOver()" disabled>Step Over</button>
            <button id="continueButton" onclick="continueExecution()" disabled>Continue</button>
            <button id="stopButton" onclick="quitDebugger()" disabled>Stop</button>
        </div>

        <div class="control-group">
            <h3>Breakpoints</h3>
            <div class="breakpoint-input">
                <input type="number" id="breakpointLine" placeholder="Line" min="1">
                <button onclick="toggleBreakpoint()">Toggle</button>
            </div>
        </div>
    </div>

    <div class="content">
        <div class="code-area" id="codeArea"></div>
        
        <div class="debug-info">
            <div class="variables-panel">
                <h3>Variables</h3>
                <div id="variables"></div>
            </div>
            <div class="stack-panel">
                <h3>Call Stack</h3>
                <div id="stackTrace"></div>
            </div>
        </div>
        
        <div class="output-panel">
            <h3>Output</h3>
            <pre id="output" class="output-content"></pre>
        </div>
    </div>

    <script>
        let codeLines = [];
        let activeBreakpoints = new Set();
        let isDebugging = false;
        let pollInterval = null;

        const codeArea = document.getElementById('codeArea');
        const output = document.getElementById('output');
        const variables = document.getElementById('variables');
        const stackTrace = document.getElementById('stackTrace');
        const fileInput = document.getElementById('fileInput');

        const debugButtons = ['stepButton', 'stepOverButton', 'continueButton', 'stopButton'];

        fileInput.addEventListener('change', handleFileSelect);

        function updateButtons(enabled) {
            debugButtons.forEach(buttonId => {
                document.getElementById(buttonId).disabled = !enabled;
            });
            document.getElementById('startButton').disabled = enabled;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || !file.name.endsWith('.py')) {
                showError('Please select a valid Python file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                codeLines = e.target.result.split('\n');
                updateCodeArea();
                activeBreakpoints.clear();
            };
            reader.readAsText(file);
        }

        function updateCodeArea() {
            codeArea.innerHTML = '';
            codeLines.forEach((line, index) => {
                const lineNum = index + 1;
                const div = document.createElement('div');
                div.className = 'code-line';
                div.dataset.line = lineNum;
                div.textContent = line;
                
                if (activeBreakpoints.has(lineNum)) {
                    div.classList.add('breakpoint');
                }
                
                div.addEventListener('click', () => toggleBreakpoint(lineNum));
                codeArea.appendChild(div);
            });
        }

        async function startDebugger() {
            if (!codeLines.length) {
                showError('Please load a Python file first');
                return;
            }

            try {
                const response = await fetch('/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: codeLines.join('\n') })
                });

                if (!response.ok) throw new Error('Failed to start debugger');

                isDebugging = true;
                updateButtons(true);
                startPolling();
                
                if (activeBreakpoints.size > 0) {
                    await sendBreakpoints();
                }

            } catch (error) {
                showError(`Error starting debugger: ${error.message}`);
            }
        }

        async function sendBreakpoints() {
            try {
                await fetch('/breakpoints', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ breakpoints: Array.from(activeBreakpoints) })
                });
            } catch (error) {
                showError(`Error setting breakpoints: ${error.message}`);
            }
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(pollStatus, 300);
        }

        async function pollStatus() {
            if (!isDebugging) return;

            try {
                const response = await fetch('/status');
                if (!response.ok) throw new Error('Failed to get status');
                
                const data = await response.json();
                updateDebuggerState(data);
                
                if (!data.is_running || data.exception) {
                    stopDebugger();
                }
            } catch (error) {
                console.error('Error polling status:', error);
                stopDebugger();
            }
        }

        function updateDebuggerState(data) {
            if (data.variables) {
                let varsHtml = '';
                for (const [key, value] of Object.entries(data.variables.locals || {})) {
                    varsHtml += `<div class="variable-item">${key} = ${value}</div>`;
                }
                variables.innerHTML = varsHtml;
            }

            if (data.stack_frames) {
                let stackHtml = '';
                data.stack_frames.forEach(frame => {
                    stackHtml += `
                        <div class="stack-frame">
                            ${frame.file}:${frame.line} in ${frame.function}
                        </div>
                    `;
                });
                stackTrace.innerHTML = stackHtml;
            }

            if (data.output) {
                output.textContent = data.output;
            }

            highlightLine(data.current_line);

            if (data.exception) {
                showError(data.exception);
            }
        }

        function highlightLine(lineNum) {
            document.querySelectorAll('.code-line').forEach(line => {
                line.classList.remove('active');
            });
            
            if (lineNum) {
                const line = document.querySelector(`[data-line="${lineNum}"]`);
                if (line) {
                    line.classList.add('active');
                    line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        async function toggleBreakpoint(lineNum) {
            if (!lineNum) {
                lineNum = parseInt(document.getElementById('breakpointLine').value);
                if (!lineNum || lineNum < 1 || lineNum > codeLines.length) {
                    showError('Invalid line number');
                    return;
                }
            }

            if (activeBreakpoints.has(lineNum)) {
                activeBreakpoints.delete(lineNum);
            } else {
                activeBreakpoints.add(lineNum);
            }

            updateCodeArea();

            if (isDebugging) {
                await sendBreakpoints();
            }
        }

        async function sendDebuggerCommand(action) {
            try {
                const response = await fetch('/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });

                if (!response.ok) throw new Error('Failed to send command');
            } catch (error) {
                showError(`Error sending command: ${error.message}`);
            }
        }

        async function step() {
            await sendDebuggerCommand('step');
        }

        async function stepOver() {
            await sendDebuggerCommand('step_over');
        }

        async function continueExecution() {
            await sendDebuggerCommand('continue');
        }

        async function quitDebugger() {
            await sendDebuggerCommand('quit');
            stopDebugger();
        }

        function stopDebugger() {
            isDebugging = false;
            updateButtons(false);
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        function showError(message) {
            output.innerHTML = `<span class="error">Error: ${message}</span>`;
        }

        updateButtons(false);
    </script>
</body>
</html>